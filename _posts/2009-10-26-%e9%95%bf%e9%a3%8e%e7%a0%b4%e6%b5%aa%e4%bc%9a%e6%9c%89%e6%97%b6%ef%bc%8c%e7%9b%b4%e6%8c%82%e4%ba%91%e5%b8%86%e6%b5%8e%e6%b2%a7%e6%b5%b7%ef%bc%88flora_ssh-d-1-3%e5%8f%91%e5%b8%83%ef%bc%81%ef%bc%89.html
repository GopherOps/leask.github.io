---
layout: post
status: publish
published: true
title: "长风破浪会有时，直挂云帆济沧海（Flora_ssh-D 1.3发布！）"
author:
  display_name: Leask
  login: leask
  email: i@leaskh.com
  url: http://www.leaskh.com
author_login: leask
author_email: i@leaskh.com
author_url: http://www.leaskh.com
wordpress_id: 57
wordpress_url: http://leaskh.wordpress.com/2009/10/26/%e9%95%bf%e9%a3%8e%e7%a0%b4%e6%b5%aa%e4%bc%9a%e6%9c%89%e6%97%b6%ef%bc%8c%e7%9b%b4%e6%8c%82%e4%ba%91%e5%b8%86%e6%b5%8e%e6%b2%a7%e6%b5%b7%ef%bc%88flora_ssh-d-1-3%e5%8f%91%e5%b8%83%ef%bc%81%ef%bc%89
date: '2009-10-26 01:47:08 +0800'
date_gmt: '2009-10-26 01:47:08 +0800'
categories:
- Uncategorized
tags: []
comments: []
---
<div id="msgcns!15BAC1A170471DB!15074" class="bvMsg">
<p>Flora_ssh-D 1.3 版本发布！
<ol>
<li>本版本重新整理程序，实现模块化；<&#47;li>
<li>引入后台运行机制，时刻检查网络；<&#47;li>
<li>简化设定，功能设置只需要留空，该功能就不会执行了；<&#47;li>
<li>直接使用DNS-O-MATIC的API更新动态IP，不再需要额外的程序了。<&#47;li><&#47;ol>
<p>不推荐升级这个版本，因为1.73版本已经开发出来了，我下一文就是发布1.73的，先发1.3是因为想保持版本的连续性。大家可以忽略。<&#47;p>
<p>Google Code上的下载地址为：<a title="http:&#47;&#47;code.google.com&#47;p&#47;flora-ssh-d&#47;downloads&#47;list" href="http:&#47;&#47;code.google.com&#47;p&#47;flora-ssh-d&#47;downloads&#47;list" target="_blank">http:&#47;&#47;code.google.com&#47;p&#47;flora-ssh-d&#47;downloads&#47;list<&#47;a> （包含源代码）<&#47;p>
<p>代码如下：<&#47;p><br />
<blockquote>
<p>(* Flora_ssh-D &#47;&#47; Version 1.3 &#47;&#47; Code by Leask Huang &#47;&#47; www.leaskh.com &#47;&#47; i@leaskh.com *)
<p>(* ======= Variable Declaration ======= *)<br &#47;>global timeTry<br &#47;>global DNSResponse<br &#47;>global isOLast
<p>(* ======= General Settings ======= *)<br &#47;>(* Custom these before you run this script *)
<p>set SSHServerName to "*******" -- Set ServerName, You must set this<br &#47;>set SSHUserName to "*******" -- Set UserName, You must set this<br &#47;>set SSHPasswd to "*******" -- Set Password, You must set this<br &#47;>set TwitterUsername to "*******" -- If you don't want to update Twitter status, leave it blank<br &#47;>set TwitterPassword to "*******" -- same as above<br &#47;>set TwitterText to "@" &amp; TwitterUsername &amp; " is online now! &#47;&#47; " &amp; (current date) -- same as above<br &#47;>set DNSUsername to "*******"<br &#47;>set DNSPassword to "*******"<br &#47;>set appStList to &#123;"Adium", "CoverSutra", "Google Notifier"&#125; -- these aplications will launch while you are online (or leave it blank)<br &#47;>set appQuitList to &#123;"CoverSutra", "Google Notifier"&#125; -- these aplications will quit while you are offline (or leave it blank)
<p>(* ======= Advanced Settings ======= *)<br &#47;>(* You don't need to change these normally *)
<p>(* ======= Main Script ======= *)<br &#47;>set isOLast to ""
<p>repeat<br &#47;>&nbsp;&nbsp;&nbsp; delay 10000<br &#47;>end repeat<br &#47;>repeat<br &#47;>&nbsp;&nbsp;&nbsp; if fnCheckNet() is true then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "online" then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnSSHCnt()<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppStart()<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnDNSUpdate()<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnTwitter()<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set isOLast to "online"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "All done!"<br &#47;>&nbsp;&nbsp;&nbsp; else<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "offline" then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnAppQuit()<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set isOLast to "offline"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "All done!"<br &#47;>&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp; -- delay 333<br &#47;>&nbsp;&nbsp;&nbsp; delay 60<br &#47;>end repeat
<p>(* ======= Functions ======= *)<br &#47;>to fnCheckNet()<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --connect-timeout 7 apple.com&#47;favicon.ico"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "online" then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Great! You are online."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br &#47;>&nbsp;&nbsp;&nbsp; on error<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if isOLast is not "offline" then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! You are offline."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br &#47;>&nbsp;&nbsp;&nbsp; end try<br &#47;>end fnCheckNet
<p>to fnCheckSSHD()<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --socks5 127.0.0.1:7070 --connect-timeout 7 apple.com&#47;favicon.ico"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "OK! SSH D has been successfully connected."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br &#47;>&nbsp;&nbsp;&nbsp; on error<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! SSH D connection failed."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br &#47;>&nbsp;&nbsp;&nbsp; end try<br &#47;>end fnCheckSSHD
<p>to fnAppStart()<br &#47;>&nbsp;&nbsp;&nbsp; if (count appStList) > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Start Applications"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to (count appStList)<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application (item intSti of appStList)<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; activate<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br &#47;>&nbsp;&nbsp;&nbsp; end if<br &#47;>end fnAppStart
<p>to fnAppQuit()<br &#47;>&nbsp;&nbsp;&nbsp; if (count appQuitList) > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Quit Applications"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat with intSti from 1 to count appQuitList<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application (item intSti of appQuitList)<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br &#47;>&nbsp;&nbsp;&nbsp; end if<br &#47;>end fnAppQuit
<p>to fnSSHCnt()<br &#47;>&nbsp;&nbsp;&nbsp; if (length of SSHServerName) > 0 and (length of SSHUserName) > 0 and (length of SSHPasswd) > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to 0<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Create SSH D connection"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; repeat while fnCheckSSHD() is false<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if timeTry > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (button returned of (display dialog "Opps! ssh -D connection failed. Do you want to retry?" &amp; return &amp; "" buttons &#123;"Retry", "Quit"&#125;)) is "Quit" then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit repeat<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fnShellSSH()<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set timeTry to timeTry + 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end repeat<br &#47;>&nbsp;&nbsp;&nbsp; end if<br &#47;>end fnSSHCnt
<p>to fnShellSSH()<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "Terminal"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; activate<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "rm ~&#47;Downloads&#47;.Flora_ssh-D.out" in window 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "killall ssh" in window 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "killall ssh-agent" in window 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script "nohup ssh -D 7070 " &amp; SSHUserName &amp; "@" &amp; SSHServerName &amp; " > Downloads&#47;.Flora_ssh-D.out" in window 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "SSH D connection request and log in request have been sent. Waiting for response from remote server."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tell application "Terminal"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do script SSHPasswd in window 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay 1<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end tell<br &#47;>&nbsp;&nbsp;&nbsp; on error<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br &#47;>&nbsp;&nbsp;&nbsp; end try<br &#47;>end fnShellSSH
<p>to fnTwitter()<br &#47;>&nbsp;&nbsp;&nbsp; if (length of TwitterUsername) > 0 and (length of TwitterPassword) > 0 and (length of TwitterText) > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Update Twitter state"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do shell script "curl --user " &amp; (quoted form of (TwitterUsername &amp; ":" &amp; TwitterPassword)) &amp; " --data-binary " &amp; (quoted form of ("status=" &amp; TwitterText)) &amp; " <a href="https:&#47;&#47;twitter.com&#47;statuses&#47;update.json"">https:&#47;&#47;twitter.com&#47;statuses&#47;update.json"<&#47;a><br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "OK! Twitter state has been successfully updated."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on error<br<br />
 &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end try<br &#47;>&nbsp;&nbsp;&nbsp; end if<br &#47;>end fnTwitter
<p>to fnDNSShell()<br &#47;>&nbsp;&nbsp;&nbsp; try<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set DNSResponse to (do shell script "curl <a href="https:&#47;&#47;"">https:&#47;&#47;"<&#47;a> &amp; DNSUsername &amp; ":" &amp; DNSPassword &amp; "@updates.dnsomatic.com&#47;nic&#47;update?&amp;wildcard=NOCHG&amp;mx=NOCHG&amp;backmx=NOCHG")<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if first word of DNSResponse is "good" then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp; on error<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false<br &#47;>&nbsp;&nbsp;&nbsp; end try<br &#47;>end fnDNSShell
<p>to fnDNSUpdate()<br &#47;>&nbsp;&nbsp;&nbsp; if (length of DNSUsername) > 0 and (length of DNSPassword) > 0 then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Update dynamic IP"<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if fnDNSShell() is true then<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "OK! Dynamic IP has been successfully updated to " &amp; (second word of DNSResponse)<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; say "Opps! Error."<br &#47;>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if<br &#47;>&nbsp;&nbsp;&nbsp; end if<br &#47;>end fnDNSUpdate<&#47;p><&#47;blockquote>  <&#47;div></p>
