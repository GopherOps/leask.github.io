<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" type="text/css" href="style.css" /><title>&#25105;&#20248;&#38597;&#19968;&#36716;&#36523;&#65292;&#22681;&#24212;&#22768;&#32780;&#20498;&#12290;&#25105;&#25381;&#19968;&#25381;&#34915;&#34966;&#65292;&#19981;&#24102;&#36208;&#19968;&#29255;&#30742;&#29926;&#12290;</title></head><body><h1 id="blog-Title"><a href="index.html">&#35;import &#34;Leask.h&#34;</a></h1><div id="bp"><h2 id="bp-15BAC1A170471DB_15070-Title">&#25105;&#20248;&#38597;&#19968;&#36716;&#36523;&#65292;&#22681;&#24212;&#22768;&#32780;&#20498;&#12290;&#25105;&#25381;&#19968;&#25381;&#34915;&#34966;&#65292;&#19981;&#24102;&#36208;&#19968;&#29255;&#30742;&#29926;&#12290;</h2><h5 id="bp-15BAC1A170471DB_15070-publish">10/24/2009 4&#58;14&#58;28 PM</h5><div id="bp-15BAC1A170471DB_15070-content" class="blogpost"><p><img style="border-bottom&#58;0px;border-left&#58;0px;display&#58;inline;border-top&#58;0px;border-right&#58;0px" title="Screen shot 2009-10-24 at 4.04.09 PM" border="0" alt="Screen shot 2009-10-24 at 4.04.09 PM" src="img/15BAC1A170471DB_15070_0.jpg" width="660" height="771" /> </p> <p>又到了周末翻墙的时间了。<br />使用了一段时间的ssh -D，我终于找回了做人的感觉，自由的空气如此新鲜，信息的绿洲让人神往，流连忘返。<br />ssh -D如此便利，速度如此流畅，让人印象深刻，但是美中不足的是每次都需要先连接，虽然上次已经分享过我写的一段脚本，实现在Mac上自动翻墙。但上次的脚本比较粗糙，仓促，于是又有了一些新的想法，目标是让翻墙更优雅、潇洒。</p> <p>上次的版本是0.3，这次改动比较大我把版本设置为0.7，下面简单说一下几点改进： <ol> <li>自动判断在线状态，如果你还没有上网，是不会执行翻墙程序的；</li> <li>自动判断翻墙结果，如果翻墙失败，程序将自动重新尝试；</li> <li>自动更新动态IP，你或许在自己的电脑上使用OpenDNS，host网站，或者其他原因需要更新动态IP（近段时间我将发文谈谈Mac上动态IP的问题，请关注）；</li> <li>自动执行程序，如果你有一些程序，如聊天软件，邮件检查软件等需要在上网的时候开启，也可以设定；</li> <li>自动退出程序，如果你有一些程序，如邮件检查程序，Last.fm等，需要在断网的时候关闭，也可以设定；</li> <li>设定是否在翻墙成功的时候更新Twitter状态；</li> <li>全程语音提示，告诉你程序目前正在干什么，十分Cool；</li></ol> <p>主要也就7点打改进，新的脚本还包含了错误语音提示，当过程中发生错误，将语音提醒你是什么原因发生错误。<br /><strong>十分建议把脚本设置为开机执行。</strong> <p><font color="#ff0000">程序已经提交到Google Code，并开放源代码：<br />地址如下：</font><a title="http&#58;//code.google.com/p/flora-ssh-d/" href="http&#58;//code.google.com/p/flora-ssh-d/" target="_blank">http&#58;//code.google.com/p/flora-ssh-d/</a><font color="#ff0000"></font><br /><font color="#ff0000">注意！访问Google Code你可能需要先翻墙。</font> <p>下面贴出源代码，大家粘贴到AppleScript Editor.app里面，修改参数然后执行就可以了。<br /><font color="#ff0000">有不明白的可以邮件或者GTalk联系我，我的邮件/GTalk/MSN/QQ同为：<a href="mailto&#58;i@leaskh.com" target="_blank">i@leaskh.com</a> 。</font> <blockquote> <p>(* Flora_ssh-D // Version 0.7 // Code by Leask Huang // www.leaskh.com // i@leaskh.com *)  <p>(* ======= Variable Declaration ======= *)<br />global YourName<br />global SSHServerName -- SSH Server Name<br />global SSHLocalPorts -- Local Port<br />global SSHUserName -- User Name on SSH Server<br />global SSHPasswd -- Password for SSH Server<br />global TwitterAPI -- Twitter API URL<br />global TwitterUsername -- Twitter User Name<br />global TwitterPassword -- Twitter Password<br />global TwitterLogin<br />global TwitterStatus<br />global JobID<br />global URLTestNet<br />global URLTestGFW<br />global appDNSUpdate<br />global appStList<br />global appQuitList<br />global isConnected<br />global isSSHCnt<br />global isUpdateTwitter<br />global isRunExSoft<br />global isQuitExSoftware<br />global isUpdateDNS<br />global isDelnohup<br />global strnohup<br />global timeTry<br />global isforceQuit  <p>(* ======= General Settings ======= *)<br />(* You don't need to change these normally *)<br />set URLTestGFW to &quot;twitter.com&quot; -- Use this URL to check is your are Blocked by GFW<br />set URLTestNet to &quot;leask.com&quot; -- Use this URL to check if you are online<br />set SSHLocalPort to &quot;7070&quot; -- Set Socks 5 local port<br />set TwitterAPI to &quot;<a href="https&#58;//twitter.com/statuses/update.json&quot;">https&#58;//twitter.com/statuses/update.json&quot;</a> -- Twitter API URL<br />-- set TwitterAPI to &quot;<a href="http&#58;//twitter.com/statuses/update.json&quot;">http&#58;//twitter.com/statuses/update.json&quot;</a> -- Simple HTTP Twitter API URL (NOT Recommend)<br />set isDelnohup to true -- Set it as true to del SSH output informtions every time<br />set strnohup to &quot;Downloads/.Flora_ssh-D.out&quot; -- Config your SSH output file location<br />set isUpdateDNS to true -- Config if you want to update your dynamic IP address for OpenDNS / DLinkDDNS / DynDNS<br />set isUpdateTwitter to true -- Config if you want to update Twitter status every time<br />set isRunExSoft to true -- Config if you want to launch some aplications when you are online<br />set isQuitExSoftware to true -- Config if you want to quit some aplications when you are offline  <p>(* ======= User Settings ======= *)<br />(* Custom these before you run this script *)<br />set SSHServerName to &quot;***.*******.com&quot; -- Set ServerName, You must set this<br />set SSHUserName to &quot;*******&quot; -- Set UserName, You must set this<br />set SSHPasswd to &quot;*******&quot; -- Set Password, You must set this<br />set TwitterUsername to &quot;&quot; -- If you don't want to update Twitter status, leave it blank<br />set TwitterPassword to &quot;&quot; -- same as above<br />set TwitterText to &quot;@&quot; &amp; TwitterUsername &amp; &quot; is online now! // &quot; &amp; (current date) -- same as above<br />set appDNSUpdate to &quot;DNS-O-Matic Updater&quot; -- Use this application to update your dynamic IP address (or leave it blank)<br />set appStList to &#123;&quot;Adium&quot;, &quot;CoverSutra&quot;, &quot;Google Notifier&quot;&#125; -- these aplications will launch while you are online (or leave it blank)<br />set appQuitList to &#123;&quot;CoverSutra&quot;, &quot;Google Notifier&quot;&#125; -- these aplications will quit while you are offline (or leave it blank)  <p>(* ======= Main Script ======= *)<br />set isConnected to false<br />set isSSHCnt to false<br />set timeTry to 0<br />set isforceQuit to false  <p>try<br />    do shell script &quot;curl &quot; &amp; URLTestNet<br />    set isConnected to true<br />on error<br />    set isConnected to true -- false<br />    say &quot;Opps! Your internet isn't ready.&quot;<br />    if (isQuitExSoftware is true) and ((count appQuitList) &gt; 0) then<br />        repeat with intSti from 1 to count appQuitList<br />            tell application (item intSti of appQuitList)<br />                quit<br />            end tell<br />        end repeat<br />    end if<br />end try  <p>if isConnected is true then<br />    repeat while isSSHCnt is false<br />        tell application &quot;System Events&quot;<br />            if exists process &quot;Terminal&quot; then<br />                tell application &quot;Terminal&quot;<br />                    quit<br />                end tell<br />                delay 3<br />                tell application &quot;Terminal&quot;<br />                    activate<br />                end tell<br />            else<br />                tell application &quot;Terminal&quot;<br />                    activate<br />                end tell<br />            end if<br />        end tell<br />        if (isUpdateDNS is true) and ((length of appDNSUpdate) &gt; 0) and (timeTry is 0) then<br />            tell application appDNSUpdate<br />                activate<br />            end tell<br />        end if<br />        tell application &quot;Terminal&quot;<br />            if (isDelnohup is true) and (timeTry is 0) then<br />                do script &quot;rm ~/&quot; &amp; strnohup in window 1<br />                delay 1<br />            end if<br />            do script &quot;killall ssh&quot; in window 1<br />            delay 1<br />            do script &quot;killall ssh-agent&quot; in window 1<br />            delay 1<br />            do script &quot;nohup ssh -D &quot; &amp; SSHLocalPort &amp; &quot; &quot; &amp; SSHUserName &amp; &quot;@&quot; &amp; SSHServerName &amp; &quot; &gt; &quot; &amp; strnohup in window 1<br />        end tell<br />        if timeTry is 0 then<br />            say &quot;Hi, &quot; &amp; (short user name of (system info)) &amp; &quot;. I am your Mac. I am configuring the network for you.&quot;<br />            set JobID to 1<br />            if isUpdateDNS is true then<br />                say &quot;Process &quot; &amp; JobID &amp; &quot;&#58; Update DNS&quot;<br />                set JobID to JobID + 1<br />            end if<br />        else<br />            set JobID to JobID + 1<br />            say &quot;Process &quot; &amp; JobID &amp; &quot;&#58; Update DNS&quot;<br />            set JobID to JobID + 1<br />            say &quot;Process &quot; &amp; JobID &amp; &quot;&#58; Get ready to retry.&quot;<br />        end if<br />        tell application &quot;Terminal&quot;<br />            do script SSHPasswd in window 1<br />        end tell<br />        say &quot;Process &quot; &amp; JobID &amp; &quot;&#58; Create SSH D connection&quot;<br />        try<br />            do shell script &quot;curl --socks5 127.0.0.1&#58;&quot; &amp; SSHLocalPort &amp; &quot; &quot; &amp; URLTestGFW<br />            say &quot;OK! SSH D has been successfully connected.&quot;<br />            set isSSHCnt to true<br />        on error<br />            set isSSHCnt to false<br />            say &quot;Opps! SSH D connection fail.&quot;<br />            if (button returned of (display dialog &quot;Opps! ssh -D connection fail. Do you want to retry?&quot; &amp; return &amp; &quot;&quot; buttons &#123;&quot;Retry&quot;, &quot;Quit&quot;&#125;)) is &quot;Retry&quot; then<br />                set timeTry to timeTry + 1<br />            else<br />                exit repeat<br />            end if<br />        end try<br />    end repeat<br />    if isSSHCnt is true then<br />        if (isUpdateTwitter is true) and ((length of TwitterUsername) &gt; 0) and ((length of SSHPasswd) &gt; 0) and ((length of TwitterText) &gt; 0) then<br />            try<br />                set JobID to JobID + 1<br />                say &quot;Process &quot; &amp; JobID &amp; &quot;&#58; Update twitter state&quot;<br />                set TwitterLogin to quoted form of (TwitterUsername &amp; &quot;&#58;&quot; &amp; TwitterPassword)<br />                set TwitterStatus to quoted form of (&quot;status=&quot; &amp; TwitterText)<br />                do shell script &quot;curl --user &quot; &amp; TwitterLogin &amp; &quot; --data-binary &quot; &amp; TwitterStatus &amp; &quot; &quot; &amp; TwitterAPI<br />                say &quot;OK! Twitter state has been successfully updated.&quot;<br />            on error<br />                say &quot;Opps! Error while updating Twitter state.&quot;<br />            end try<br />        end if<br />        if (isRunExSoft is true) and ((count appStList) &gt; 0) then<br />            set JobID to JobID + 1<br />            say &quot;Process &quot; &amp; JobID &amp; &quot;&#58; Start Applications&quot;<br />            repeat with intSti from 1 to count appStList<br />                tell application (item intSti of appStList)<br />                    activate<br />                end tell<br />            end repeat<br />        end if<br />    end if<br />    tell application &quot;Terminal&quot;<br />        quit<br />    end tell<br />    if (isUpdateDNS is true) and ((length of appDNSUpdate) &gt; 0) then<br />        tell application appDNSUpdate<br />            quit<br />        end tell<br />    end if<br />    say &quot;All done! Bye!&quot;<br />end if</p></p></blockquote>  </p></div><h3>Comments</h3><div id="bp-15BAC1A170471DB_15070-comments" class="comments"></div></div></body></html>