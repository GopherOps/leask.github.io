<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" type="text/css" href="style.css" /><title>Flora_ssh-D Version 2.47&#21457;&#24067;&#65281;//&#20027;&#35201;&#20462;&#27491;&#65306;iTunes&#26356;&#26032;&#22823;&#37327;Podcast&#30340;&#26102;&#20505;&#33050;&#26412;&#36229;&#26102;&#30340;Bug&#12290;</title></head><body><h1 id="blog-Title"><a href="index.html">&#35;import &#34;Leask.h&#34;</a></h1><div id="bp"><h2 id="bp-15BAC1A170471DB_15106-Title">Flora_ssh-D Version 2.47&#21457;&#24067;&#65281;//&#20027;&#35201;&#20462;&#27491;&#65306;iTunes&#26356;&#26032;&#22823;&#37327;Podcast&#30340;&#26102;&#20505;&#33050;&#26412;&#36229;&#26102;&#30340;Bug&#12290;</h2><h5 id="bp-15BAC1A170471DB_15106-publish">11/16/2009 6&#58;27&#58;18 PM</h5><div id="bp-15BAC1A170471DB_15106-content" class="blogpost"><p>这个版本早就做好了，但是一直徘徊要不要放出来。因为这段时间我在尝试修改autossh的源代码。autossh是一个很优秀的开源项目，我希望build一个带有更完善翻墙功能的autossh版本，目前还是遇到很多问题。由于工作比较忙，可能一时三刻还完成不了，所以还是放出这个版本。这个版本对于一般的用户已经比较完美了，但是对于用Terminal比较多的用户，还是会有一点不适应的，因为脚本中连接ssh的时候会独占Terminal，这个问题我暂时还没有比较好的解决办法。</p> <p>另外为了提高安全性，我尝试把各种用户名和密码保存在Mac的Keychain里面，但是不知道是不是因为Mac OS X 10.6.x中比较烦人的脚本安全规则作怪，脚本每次访问Keychain都需要弹出对话框让用户确认，所以最终还是放弃了这个做法，希望有解决办法的朋友指教一下。</p> <p><img style="border-bottom&#58;0px;border-left&#58;0px;display&#58;inline;border-top&#58;0px;border-right&#58;0px" title="Screen shot 2009-10-28 at 8.33.53 PM" border="0" alt="Screen shot 2009-10-28 at 8.33.53 PM" src="img/15BAC1A170471DB_15106_0.jpg" width="640" height="355" /><img style="border-bottom&#58;0px;border-left&#58;0px;display&#58;inline;border-top&#58;0px;border-right&#58;0px" title="Screen shot 2009-10-28 at 8.34.34 PM" border="0" alt="Screen shot 2009-10-28 at 8.34.34 PM" src="img/15BAC1A170471DB_15106_1.jpg" width="614" height="427" /> </p> <p>好了，不多说，最后还是放出源代码（和往常一样，我将在Google Code放出封装好的app和源代码，有需要的朋友直接去下载更新吧）：</p> <blockquote> <p><em>(* Flora_ssh-D Version 2.47<br />Open Source Project Home/开源项目主页&#58; </em><a href="http&#58;//code.google.com/p/flora-ssh-d/"><em>http&#58;//code.google.com/p/flora-ssh-d/</em></a><br /><em>Code by/程序编写&#58; 黄思夏 / Leask Huang<br />Blog&#58; </em><a href="http&#58;//www.leaskh.com"><em>http&#58;//www.leaskh.com</em></a><em> (天朝访问需翻墙)<br />E-mail/GTalk/MSN/QQ&#58; i@leaskh.com *) </em></p> <p><em>(* CUSTOM THESE SETTINGS BEFORE YOUR RUN THINS SCRIPT // 运行此脚本前请先配置此区域的参数<br />    LEAVE IT BLANK IF YOU DON'T NEED IT // 如你不需要其中某些功能请将设置留空 *)<br />property SSHServerName &#58; &quot;&quot;<br />property SSHUserName &#58; &quot;&quot;<br />property SSHPasswd &#58; &quot;&quot;<br />property TwitterUsername &#58; &quot;&quot;<br />property TwitterPassword &#58; &quot;&quot;<br />property DNSUsername &#58; &quot;&quot;<br />property DNSPassword &#58; &quot;&quot;<br />property LastfmUsername &#58; &quot;&quot;<br />property LastfmPassword &#58; &quot;&quot;<br />property appStList &#58; &#123;&#125;<br />property appQuitList &#58; &#123;&#125; </em> <p><em>(* Example/示例 // English Help // 中文帮助 <br />property SSHServerName &#58; &quot;ssh.yourdomain.com&quot;   -- ssh -D Server Address (or leave it blank)  //  ssh -D 翻墙服务器地址 (不使用ssh -D则留空)<br />property SSHUserName &#58; &quot;*******&quot;   -- ssh -D User Name (or leave it blank)  //  ssh -D 帐号 (不使用ssh -D则留空)<br />property SSHPasswd &#58; &quot;*******&quot;   -- ssh -D Password (or leave it blank) //  ssh -D 密码 (不使用ssh -D则留空)<br />property TwitterUsername &#58; &quot;*******&quot;   -- Twitter User Name (or leave it blank)  //  Twitter帐号 (不使用Twitter则留空)<br />property TwitterPassword &#58; &quot;*******&quot;   -- Twitter Password (or leave it blank)  //  Twitter密码 (不使用Twitter则留空)<br />property DNSUsername &#58; &quot;*******&quot;   -- DNS User Name (or leave it blank)  //  DNS-O-MATIC动态IP帐号 (不使用动态IP则留空)<br />property DNSPassword &#58; &quot;*******&quot;   -- DNS Password (or leave it blank)  //  DNS-O-MATIC动态IP密码 (不使用动态IP则留空)<br />property LastfmUsername &#58; &quot;*******&quot;   -- last.fm User Name (or leave it blank)  // last.fm帐号 (不使用last.fm则留空)<br />property LastfmPassword &#58; &quot;*******&quot;   -- last.fm Password (or leave it blank)  //  last.fm密码 (不使用last.fm则留空)<br />property appStList &#58; &#123;&quot;App 1&quot;, &quot;软件2&quot;,&quot;iChat&quot;&#125;   -- these apps will launch while you are online (or leave it blank)  //  填写【在线】时需【开启】的软件(不使用此功能则留空)<br />property appQuitList &#58; &#123;&quot;App 1&quot;, &quot;软件2&quot;,&quot;QQ&quot;&#125;   -- these apps will quit while you are offline (or leave it blank)  //  填写【离线】时需【关闭】的软件(不使用此功能则留空)<br />*) </em> <p><em>(* ======= Variable Declaration ======= *)<br />global timeTry<br />global DNSResponse<br />global isOLast<br />global iTsCurDBID<br />global iTsORSoundVolume<br />global strSNGArtist<br />global strSNGName<br />global strSNGAlbum<br />global strSNGTrackNumber<br />global strSNGDuration<br />global intIdleCount </em> <p><em>(* ======= Main Script ======= *)<br />on run<br />    set isOLast to &quot;&quot;<br />    set iTsCurDBID to &quot;&quot;<br />    set intIdleCount to 10<br />end run </em> <p><em>on quit<br />    with timeout of 3600 seconds<br />        if isOLast is &quot;online&quot; then fnTwitter(&quot;I am offline now! // &quot; &amp; (current date), true)<br />        fnShellSSHEnd(true)<br />        fnAppQuit()<br />        continue quit<br />    end timeout<br />end quit </em> <p><em>on idle<br />    with timeout of 3600 seconds<br />        if fnCheckNet() is true then<br />            if intIdleCount &gt; 9 then<br />                fnSSHCnt()<br />                if isOLast is not &quot;online&quot; then<br />                    fnAppStart()<br />                    fnDNSUpdate()<br />                    fnTwitter(&quot;I am online now! // &quot; &amp; (current date), true)<br />                end if<br />                set intIdleCount to 0<br />            end if<br />            fnMusic(true)<br />            set intIdleCount to intIdleCount + 1<br />            set isOLast to &quot;online&quot;<br />        else<br />            fnMusic(false)<br />            if isOLast is not &quot;offline&quot; then<br />                fnShellSSHEnd(true)<br />                fnAppQuit()<br />            end if<br />            set isOLast to &quot;offline&quot;<br />        end if<br />    end timeout<br />    return 60<br />end idle </em> <p><em>(* ======= Functions ======= *)<br />to fnCheckNet()<br />    try<br />        do shell script &quot;curl --connect-timeout 30 \&quot;apple.com/favicon.ico\&quot;&quot;<br />        if isOLast is not &quot;online&quot; then SmartSay(&#123;&quot;Online&quot;&#125;)<br />        return true<br />    on error<br />        if isOLast is not &quot;offline&quot; then SmartSay(&#123;&quot;Offline&quot;&#125;)<br />        return false<br />    end try<br />end fnCheckNet </em> <p><em>to fnAppStart()<br />    if (count appStList) &gt; 0 then<br />        SmartSay(&#123;&quot;Start Apps&quot;&#125;)<br />        try<br />            repeat with intSti from 1 to (count appStList)<br />                tell application (item intSti of appStList) to activate<br />            end repeat<br />            SmartSay(&#123;&quot;OK&quot;&#125;)<br />        on error<br />            SmartSay(&#123;&quot;Failed&quot;&#125;)<br />        end try<br />    end if<br />end fnAppStart </em> <p><em>to fnAppQuit()<br />    if (count appQuitList) &gt; 0 then<br />        SmartSay(&#123;&quot;Quit Applications&quot;&#125;)<br />        try<br />            repeat with intSti from 1 to count appQuitList<br />                tell application (item intSti of appQuitList) to quit<br />            end repeat<br />            SmartSay(&#123;&quot;OK&quot;&#125;)<br />        on error<br />            SmartSay(&#123;&quot;Failed&quot;&#125;)<br />        end try<br />    end if<br />end fnAppQuit </em> <p><em>to fnSSHCnt()<br />    if (length of SSHServerName) &gt; 0 and (length of SSHUserName) &gt; 0 and (length of SSHPasswd) &gt; 0 then<br />        set timeTry to 0<br />        repeat while fnCheckSSHD() is false<br />            SmartSay(&#123;&quot;Connect SSH D&quot;&#125;)<br />            if timeTry &gt; 0 then if (button returned of (display dialog &quot;ssh -D connection failed.&quot; &amp; return &amp; &quot;&quot; buttons &#123;&quot;Retry&quot;, &quot;Ignore&quot;&#125;)) is &quot;Ignore&quot; then exit repeat<br />            fnShellSSH()<br />            set timeTry to timeTry + 1<br />        end repeat<br />    end if<br />end fnSSHCnt </em> <p><em>to fnCheckSSHD()<br />    try<br />        do shell script &quot;curl --socks5 127.0.0.1&#58;7070 --connect-timeout 30 \&quot;apple.com/favicon.ico\&quot;&quot;<br />        if timeTry &gt; 0 then SmartSay(&#123;&quot;OK&quot;&#125;)<br />        return true<br />    on error<br />        if timeTry &gt; 0 then SmartSay(&#123;&quot;Failed&quot;&#125;)<br />        return false<br />    end try<br />end fnCheckSSHD </em> <p><em>to fnShellSSH()<br />    try<br />        try<br />            do shell script &quot;killall Terminal&quot;<br />        end try<br />        tell application &quot;Terminal&quot;<br />            activate<br />            fnShellSSHEnd(false) of me<br />            delay 1<br />            do script &quot;nohup ssh -D 7070 &quot; &amp; SSHUserName &amp; &quot;@&quot; &amp; SSHServerName &amp; &quot; &gt; Downloads/.Flora_ssh-D.out&quot; in window 1<br />        end tell<br />        SmartSay(&#123;&quot;SSH D connection request and log in request have been sent. Waiting for response from remote server.&quot;&#125;)<br />        tell application &quot;Terminal&quot;<br />            do script SSHPasswd in window 1<br />            delay 1<br />            quit<br />        end tell<br />    end try<br />end fnShellSSH </em> <p><em>to fnShellSSHEnd(isSay)<br />    if (length of SSHServerName) &gt; 0 and (length of SSHUserName) &gt; 0 and (length of SSHPasswd) &gt; 0 then<br />        if isSay is true then SmartSay(&#123;&quot;Disconnect SSH D&quot;&#125;)<br />        try<br />            do shell script &quot;killall ssh&quot;<br />            do shell script &quot;killall ssh-agent&quot;<br />            do shell script &quot;rm ~/Downloads/.Flora_ssh-D.out&quot;<br />        end try<br />    end if<br />end fnShellSSHEnd </em> <p><em>to fnTwitter(strTwText, isSay)<br />    if (length of TwitterUsername) &gt; 0 and (length of TwitterPassword) &gt; 0 and (length of strTwText) &gt; 0 then<br />        if (length of strTwText) &gt; 140 then<br />            set strTwText to (characters 1 through 137 of strTwText as string) &amp; &quot;...&quot;<br />        end if<br />        if isSay is true then SmartSay(&#123;&quot;Update Twitter state&quot;&#125;)<br />        try<br />            do shell script &quot;curl --connect-timeout 30  --user &quot; &amp; (quoted form of (TwitterUsername &amp; &quot;&#58;&quot; &amp; TwitterPassword)) &amp; &quot; --data-binary &quot; &amp; (quoted form of (&quot;status=&quot; &amp; strTwText)) &amp; &quot; \&quot;</em><a href="https&#58;//twitter.com/statuses/update.json\&quot;&quot;"><em>https&#58;//twitter.com/statuses/update.json\&quot;&quot;</em></a><br /><em>            if isSay is true then SmartSay(&#123;&quot;OK&quot;&#125;)<br />        on error<br />            if isSay is true then<br />                SmartSay(&#123;&quot;Failed&quot;&#125;)<br />            else<br />                SmartSay(&#123;&quot;Update Twitter state failed&quot;&#125;)<br />            end if<br />        end try<br />    end if<br />end fnTwitter </em> <p><em>to fnDNSShell()<br />    try<br />        set DNSResponse to (do shell script &quot;curl --connect-timeout 30 \&quot;</em><a href="https&#58;//&quot;"><em>https&#58;//&quot;</em></a><em> &amp; DNSUsername &amp; &quot;&#58;&quot; &amp; DNSPassword &amp; &quot;@updates.dnsomatic.com/nic/update?&amp;wildcard=NOCHG&amp;mx=NOCHG&amp;backmx=NOCHG\&quot;&quot;)<br />        if first word of DNSResponse is &quot;good&quot; then -- (second word of DNSResponse) is IP address<br />            return true<br />        else<br />            return false<br />        end if<br />    on error<br />        return false<br />    end try<br />end fnDNSShell </em> <p><em>to fnDNSUpdate()<br />    if (length of DNSUsername) &gt; 0 and (length of DNSPassword) &gt; 0 then<br />        SmartSay(&#123;&quot;Update dynamic IP&quot;&#125;)<br />        if fnDNSShell() is true then<br />            SmartSay(&#123;&quot;OK&quot;&#125;)<br />        else<br />            SmartSay(&#123;&quot;Failed&quot;&#125;)<br />        end if<br />    end if<br />end fnDNSUpdate </em> <p><em>to fnURLec(strToUEC)<br />    return do shell script &quot;python -c 'import sys, urllib; print urllib.quote(sys.argv[1])' \&quot;&quot; &amp; strToUEC &amp; &quot;\&quot;&quot;<br />end fnURLec </em> <p><em>to fniTunesisActive()<br />    tell application &quot;System Events&quot; to return (name of processes contains &quot;iTunes&quot;)<br />end fniTunesisActive </em> <p><em>to fuisiTunesNUD()<br />    if fniTunesisActive() is true then<br />        tell application &quot;iTunes&quot;<br />            if player state is playing then<br />                set iTsNewDBID to (get database ID of current track)<br />                if iTsNewDBID is not iTsCurDBID then<br />                    set strSNGArtist to (get artist of current track)<br />                    set strSNGName to (get name of current track)<br />                    set strSNGAlbum to (get album of current track)<br />                    set strSNGTrackNumber to (get track number of current track)<br />                    set strSNGDuration to (get duration of current track as integer)<br />                    set iTsCurDBID to iTsNewDBID<br />                    return true<br />                else<br />                    return false<br />                end if<br />            else<br />                return false<br />            end if<br />        end tell<br />    else<br />        return false<br />    end if<br />end fuisiTunesNUD </em> <p><em>to SmartSay(strToSay)<br />    set isiTPing to false<br />    if fniTunesisActive() is true then<br />        tell application &quot;iTunes&quot; to if player state is playing then set isiTPing to true<br />    end if<br />    if isiTPing is true then<br />        tell application &quot;iTunes&quot;<br />            set iTsORSoundVolume to sound volume<br />            set timeTry to 0<br />            repeat while timeTry &lt; 10<br />                set timeTry to timeTry + 1<br />                set sound volume to iTsORSoundVolume * (15 - timeTry) / 15<br />                delay 0.1<br />            end repeat<br />        end tell<br />        repeat with intSti from 1 to (count strToSay)<br />            say &quot;&quot; &amp; (item intSti of strToSay)<br />            if intSti &lt; (count strToSay) then delay 1<br />        end repeat<br />        tell application &quot;iTunes&quot;<br />            set timeTry to 10<br />            repeat while timeTry &gt; 0<br />                set timeTry to timeTry - 1<br />                set sound volume to iTsORSoundVolume * (15 - timeTry) / 15<br />                delay 0.1<br />            end repeat<br />        end tell<br />    else<br />        say &quot;&quot; &amp; strToSay<br />    end if<br />end SmartSay </em> <p><em>to fnMusic(isOnline)<br />    if fuisiTunesNUD() is true then<br />        SmartSay(&#123;strSNGName, strSNGArtist&#125;)<br />        if isOnline is true then<br />            if (length of LastfmUsername) &gt; 0 and (length of LastfmPassword) &gt; 0 then<br />                try<br />                    do shell script &quot;curl --connect-timeout 30 \&quot;</em><a href="http&#58;//lastfmstats.livefrombmore.com/universalscrobbler/scrobble.php?submissionType=track&quot;"><em>http&#58;//lastfmstats.livefrombmore.com/universalscrobbler/scrobble.php?submissionType=track&quot;</em></a><em> &amp; &quot;&amp;username=&quot; &amp; LastfmUsername &amp; &quot;&amp;password=&quot; &amp; LastfmPassword &amp; &quot;&amp;artist=&quot; &amp; fnURLec(strSNGArtist) &amp; &quot;&amp;track=&quot; &amp; fnURLec(strSNGName) &amp; &quot;&amp;album=&quot; &amp; fnURLec(strSNGAlbum) &amp; &quot;&amp;number=&quot; &amp; strSNGTrackNumber &amp; &quot;&amp;duration=&quot; &amp; strSNGDuration &amp; &quot;\&quot;&quot;<br />                on error<br />                    SmartSay(&#123;&quot;Scrobbling Failed&quot;&#125;)<br />                end try<br />                fnTwitter(&quot;I am listening to #&quot; &amp; strSNGName &amp; &quot; by #&quot; &amp; strSNGArtist &amp; &quot; in album #&quot; &amp; strSNGAlbum &amp; &quot;. // &quot; &amp; (current date), false)<br />            end if<br />        end if<br />    end if<br />end fnMusic</em></p></p></p></blockquote>  </div><h3>Comments</h3><div id="bp-15BAC1A170471DB_15106-comments" class="comments"></div></div></body></html>