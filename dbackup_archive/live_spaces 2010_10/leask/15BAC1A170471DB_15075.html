<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" type="text/css" href="style.css" /><title>&#22825;&#26397;&#26149;&#33394;&#20851;&#25105;&#19981;&#20303;&#65292;&#19968;&#27573;&#20195;&#30721;&#35753;&#25105;&#20986;&#22681;&#26469;&#65288;Flora_ssh-D 1.73&#38534;&#37325;&#21457;&#24067;&#65281;&#65289;</title></head><body><h1 id="blog-Title"><a href="index.html">&#35;import &#34;Leask.h&#34;</a></h1><div id="bp"><h2 id="bp-15BAC1A170471DB_15075-Title">&#22825;&#26397;&#26149;&#33394;&#20851;&#25105;&#19981;&#20303;&#65292;&#19968;&#27573;&#20195;&#30721;&#35753;&#25105;&#20986;&#22681;&#26469;&#65288;Flora_ssh-D 1.73&#38534;&#37325;&#21457;&#24067;&#65281;&#65289;</h2><h5 id="bp-15BAC1A170471DB_15075-publish">10/26/2009 10&#58;22&#58;06 AM</h5><div id="bp-15BAC1A170471DB_15075-content" class="blogpost"><p></p> <p>Flora_ssh-D 1.73已经不单单是翻墙脚本了，目前我计划把Flora_ssh-D发展成一个自动化的助理，让你的电脑用得更舒心。  <p>目前的功能如下：  <ol> <li>自动检查网络状态，根据在线和离线的状态为你开启和关闭软件；  <li>自动检查ssh -D的连接状态，如果断开了会为你自动连接，连接失败将提示自动重连，使用后墙对你来说基本上是透明的；  <li>VoiceOver语音功能，这个功能和iPod一样，你的iTunes在播放的时候能够语音提示你正在播放的歌名和艺术家名字；  <li>语音提醒功能的改进，当需要语音提示用户操作的时候，如果你的iTunes正在播放，将自动降低你的iTunes音量，在语音提示结束后还原音量；  <li>使用API自动将你正在收听的音乐记录到Last.fm，你已经不再需要额外的iTunes插件来记录了；  <li>使用API自动更新你在DNS-O-MATIC上的动态IP，你不再需要其他额外的软件更新动态IP了；  <li>新版本使用新的idle时间管理，对比上一个版本有很大的效能提升，后台的常驻几乎不占用任何资源。</li></ol> <p>Google Code上下载地址如下：<a title="http&#58;//code.google.com/p/flora-ssh-d/downloads/list" href="http&#58;//code.google.com/p/flora-ssh-d/downloads/list" target="_blank">http&#58;//code.google.com/p/flora-ssh-d/downloads/list</a> （包含源代码）<br />// PS&#58; 使用翻墙功能你需要先有SSH帐号，使用其他功能则不需要。</p> <p>源代码如下：</p> <blockquote> <p>(* Flora_ssh-D // Version 1.73 // Code by Leask Huang // www.leaskh.com // i@leaskh.com *)  <p>(* ======= Variable Declaration ======= *)<br />global timeTry<br />global DNSResponse<br />global isOLast<br />global iTsCurDBID<br />global iTsORSoundVolume<br />global strSNGArtist<br />global strSNGName<br />global strSNGAlbum<br />global strSNGTrackNumber<br />global strSNGDuration  <p>(* ======= General Settings ======= *)<br />(* Custom these before you run this script *)<br />property SSHServerName &#58; &quot;***.*******.com&quot; -- Set ssh -D ServerName (or leave it blank)<br />property SSHUserName &#58; &quot;*******&quot; -- Set UserName (or leave it blank)<br />property SSHPasswd &#58; &quot;*******&quot; -- Set Password (or leave it blank)<br />property TwitterUsername &#58; &quot;*******&quot; -- If you don't want to update Twitter status, leave it blank<br />property TwitterPassword &#58; &quot;*******&quot; -- same as above<br />property TwitterText &#58; &quot;@&quot; &amp; TwitterUsername &amp; &quot; is online now! // &quot; &amp; (current date) -- same as above<br />property DNSUsername &#58; &quot;*******&quot; -- Set DNS UserName (or leave it blank)<br />property DNSPassword &#58; &quot;*******&quot; -- Set Password (or leave it blank)<br />property LastfmUsername &#58; &quot;*******&quot; -- Set Last.fm UserName (or leave it blank)<br />property LastfmPassword &#58; &quot;*******&quot; -- Set Password (or leave it blank)<br />property appStList &#58; &#123;&quot;***&quot;, &quot;***&quot;&#125; -- these aplications will launch while you are online (or leave it blank)<br />property appQuitList &#58; &#123;&quot;***&quot;, &quot;***&quot;&#125; -- these aplications will quit while you are offline (or leave it blank)  <p>(* ======= Main Script ======= *)<br />on run<br />    set isOLast to &quot;&quot;<br />    set iTsCurDBID to &quot;&quot;<br />end run  <p>on quit<br />    continue quit<br />end quit  <p>on idle<br />    if fnCheckNet() is true then<br />        fnSSHCnt()<br />        if isOLast is not &quot;online&quot; then<br />            fnAppStart()<br />            fnDNSUpdate()<br />            fnTwitter()<br />        end if<br />        fnLastfm()<br />        set isOLast to &quot;online&quot;<br />    else<br />        if isOLast is not &quot;offline&quot; then fnAppQuit()<br />        set isOLast to &quot;offline&quot;<br />    end if<br />    return 180<br />end idle  <p>(* ======= Functions ======= *)<br />to fnCheckNet()<br />    try<br />        do shell script &quot;curl --connect-timeout 33 \&quot;apple.com/favicon.ico\&quot;&quot;<br />        if isOLast is not &quot;online&quot; then SmartSay(&quot;Online&quot;)<br />        return true<br />    on error<br />        if isOLast is not &quot;offline&quot; then SmartSay(&quot;Offline&quot;)<br />        return false<br />    end try<br />end fnCheckNet  <p>to fnAppStart()<br />    if (count appStList) &gt; 0 then<br />        SmartSay(&quot;Start Apps&quot;)<br />        try<br />            repeat with intSti from 1 to (count appStList)<br />                tell application (item intSti of appStList) to activate<br />            end repeat<br />            SmartSay(&quot;OK&quot;)<br />        on error<br />            SmartSay(&quot;Failed&quot;)<br />        end try<br />    end if<br />end fnAppStart  <p>to fnAppQuit()<br />    if (count appQuitList) &gt; 0 then<br />        SmartSay(&quot;Quit Applications&quot;)<br />        try<br />            repeat with intSti from 1 to count appQuitList<br />                tell application (item intSti of appQuitList) to quit<br />            end repeat<br />            SmartSay(&quot;OK&quot;)<br />        on error<br />            SmartSay(&quot;Failed&quot;)<br />        end try<br />    end if<br />end fnAppQuit  <p>to fnSSHCnt()<br />    if (length of SSHServerName) &gt; 0 and (length of SSHUserName) &gt; 0 and (length of SSHPasswd) &gt; 0 then<br />        set timeTry to 0<br />        repeat while fnCheckSSHD() is false<br />            SmartSay(&quot;Connect SSH D&quot;)<br />            if timeTry &gt; 0 then if (button returned of (display dialog &quot;ssh -D connection failed.&quot; &amp; return &amp; &quot;&quot; buttons &#123;&quot;Retry&quot;, &quot;Ignore&quot;&#125;)) is &quot;Ignore&quot; then exit repeat<br />            fnShellSSH()<br />            set timeTry to timeTry + 1<br />        end repeat<br />    end if<br />end fnSSHCnt  <p>to fnCheckSSHD()<br />    try<br />        do shell script &quot;curl --socks5 127.0.0.1&#58;7070 --connect-timeout 33 \&quot;apple.com/favicon.ico\&quot;&quot;<br />        if timeTry &gt; 0 then SmartSay(&quot;OK&quot;)<br />        return true<br />    on error<br />        if timeTry &gt; 0 then SmartSay(&quot;Failed&quot;)<br />        return false<br />    end try<br />end fnCheckSSHD  <p>to fnShellSSH()<br />    try<br />        tell application &quot;Terminal&quot;<br />            quit<br />            delay 1<br />            activate<br />            delay 1<br />            do script &quot;rm ~/Downloads/.Flora_ssh-D.out&quot; in window 1<br />            do script &quot;killall ssh&quot; in window 1<br />            do script &quot;killall ssh-agent&quot; in window 1<br />            do script &quot;nohup ssh -D 7070 &quot; &amp; SSHUserName &amp; &quot;@&quot; &amp; SSHServerName &amp; &quot; &gt; Downloads/.Flora_ssh-D.out&quot; in window 1<br />        end tell<br />        SmartSay(&quot;SSH D connection request and log in request have been sent. Waiting for response from remote server.&quot;)<br />        tell application &quot;Terminal&quot;<br />            do script SSHPasswd in window 1<br />            delay 1<br />            quit<br />        end tell<br />    end try<br />end fnShellSSH  <p>to fnTwitter()<br />    if (length of TwitterUsername) &gt; 0 and (length of TwitterPassword) &gt; 0 and (length of TwitterText) &gt; 0 then<br />        SmartSay(&quot;Update Twitter state&quot;)<br />        try<br />            do shell script &quot;curl --connect-timeout 33  --user &quot; &amp; (quoted form of (TwitterUsername &amp; &quot;&#58;&quot; &amp; TwitterPassword)) &amp; &quot; --data-binary &quot; &amp; (quoted form of (&quot;status=&quot; &amp; TwitterText)) &amp; &quot; \&quot;<a href="https&#58;//twitter.com/statuses/update.json\&quot;&quot;">https&#58;//twitter.com/statuses/update.json\&quot;&quot;</a><br />            SmartSay(&quot;OK&quot;)<br />        on error<br />            SmartSay(&quot;Failed&quot;)<br />        end try<br />    end if<br />end fnTwitter  <p>to fnDNSShell()<br />    try<br />        set DNSResponse to (do shell script &quot;curl --connect-timeout 33 \&quot;<a href="https&#58;//&quot;">https&#58;//&quot;</a> &amp; DNSUsername &amp; &quot;&#58;&quot; &amp; DNSPassword &amp; &quot;@updates.dnsomatic.com/nic/update?&amp;wildcard=NOCHG&amp;mx=NOCHG&amp;backmx=NOCHG\&quot;&quot;)<br />        if first word of DNSResponse is &quot;good&quot; then -- (second word of DNSResponse) is IP address<br />            return true<br />        else<br />            return false<br />        end if<br />    on error<br />        return false<br />    end try<br />end fnDNSShell  <p>to fnDNSUpdate()<br />    if (length of DNSUsername) &gt; 0 and (length of DNSPassword) &gt; 0 then<br />        SmartSay(&quot;Update dynamic IP&quot;)<br />        if fnDNSShell() is true then<br />            SmartSay(&quot;OK&quot;)<br />        else<br />            SmartSay(&quot;Failed&quot;)<br />        end if<br />    end if<br />end fnDNSUpdate  <p>to fnURLec(strToUEC)<br />    return do shell script &quot;python -c 'import sys, urllib; print urllib.quote(sys.argv[1])' \&quot;&quot; &amp; strToUEC &amp; &quot;\&quot;&quot;<br />end fnURLec  <p>to fniTunesisActive()<br />    tell application &quot;System Events&quot; to return (name of processes contains &quot;iTunes&quot;)<br />end fniTunesisActive  <p>to fuisiTunesNUD()<br />    if fniTunesisActive() is true then<br />        tell application &quot;iTunes&quot;<br />            if player state is playing then<br />                set iTsNewDBID to (get database ID of current track)<br />                if iTsNewDBID is not iTsCurDBID then<br />                    set strSNGArtist to (get artist of current track)<br />                    set strSNGName to (get name of current track)<br />                    set strSNGAlbum to (get album of current track)<br />                    set strSNGTrackNumber to (get track number of current track)<br />                    set strSNGDuration to (get duration of current track as integer)<br />                    set iTsCurDBID to iTsNewDBID<br />                    return true<br />                else<br />                    return false<br />                end if<br />            else<br />                return false<br />            end if<br />        end tell<br />    else<br />        return false<br />    end if<br />end fuisiTunesNUD  <p>to SmartSay(strToSay)<br />    set isiTPing to false<br />    if fniTunesisActive() is true then<br />        tell application &quot;iTunes&quot; to if player state is playing then set isiTPing to true<br />    end if<br />    if isiTPing is true then<br />        tell application &quot;iTunes&quot;<br />            set iTsORSoundVolume to sound volume<br />            set sound volume to iTsORSoundVolume * 0.333<br />        end tell<br />        say &quot;&quot; &amp; strToSay<br />        tell application &quot;iTunes&quot; to set sound volume to iTsORSoundVolume<br />    else<br />        say &quot;&quot; &amp; strToSay<br />    end if<br />end SmartSay  <p>to fnLastfm()<br />    if fuisiTunesNUD() is true then<br />        if (length of strSNGName) &gt; 0 or (length of strSNGArtist) &gt; 0 then<br />            tell application &quot;iTunes&quot;<br />                set iTsORSoundVolume to sound volume<br />                set sound volume to iTsORSoundVolume * 0.333<br />            end tell<br />            if (length of strSNGName) &gt; 0 then<br />                say strSNGName<br />                delay 1<br />            end if<br />            if (length of strSNGArtist) &gt; 0 then say strSNGArtist<br />            tell application &quot;iTunes&quot; to set sound volume to iTsORSoundVolume<br />        end if<br />        if (length of LastfmUsername) &gt; 0 and (length of LastfmPassword) &gt; 0 then<br />            try<br />                do shell script &quot;curl --connect-timeout 33 \&quot;<a href="http&#58;//lastfmstats.livefrombmore.com/universalscrobbler/scrobble.php?submissionType=track&quot;">http&#58;//lastfmstats.livefrombmore.com/universalscrobbler/scrobble.php?submissionType=track&quot;</a> &amp; &quot;&amp;username=&quot; &amp; LastfmUsername &amp; &quot;&amp;password=&quot; &amp; LastfmPassword &amp; &quot;&amp;artist=&quot; &amp; fnURLec(strSNGArtist) &amp; &quot;&amp;track=&quot; &amp; fnURLec(strSNGName) &amp; &quot;&amp;album=&quot; &amp; fnURLec(strSNGAlbum) &amp; &quot;&amp;number=&quot; &amp; strSNGTrackNumber &amp; &quot;&amp;duration=&quot; &amp; strSNGDuration &amp; &quot;\&quot;&quot;<br />            on error<br />                SmartSay(&quot;Scrobbling Failed&quot;)<br />            end try<br />        end if<br />    end if<br />end fnLastfm</p></p></p></p></p></blockquote>  </div><h3>Comments</h3><div id="bp-15BAC1A170471DB_15075-comments" class="comments"></div></div></body></html>