<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" type="text/css" href="style.css" /><title>&#38271;&#39118;&#30772;&#28010;&#20250;&#26377;&#26102;&#65292;&#30452;&#25346;&#20113;&#24070;&#27982;&#27815;&#28023;&#65288;Flora_ssh-D 1.3&#21457;&#24067;&#65281;&#65289;</title></head><body><h1 id="blog-Title"><a href="index.html">&#35;import &#34;Leask.h&#34;</a></h1><div id="bp"><h2 id="bp-15BAC1A170471DB_15074-Title">&#38271;&#39118;&#30772;&#28010;&#20250;&#26377;&#26102;&#65292;&#30452;&#25346;&#20113;&#24070;&#27982;&#27815;&#28023;&#65288;Flora_ssh-D 1.3&#21457;&#24067;&#65281;&#65289;</h2><h5 id="bp-15BAC1A170471DB_15074-publish">10/26/2009 9&#58;47&#58;08 AM</h5><div id="bp-15BAC1A170471DB_15074-content" class="blogpost"><p>Flora_ssh-D 1.3 版本发布！ <ol> <li>本版本重新整理程序，实现模块化；</li> <li>引入后台运行机制，时刻检查网络；</li> <li>简化设定，功能设置只需要留空，该功能就不会执行了；</li> <li>直接使用DNS-O-MATIC的API更新动态IP，不再需要额外的程序了。</li></ol> <p>不推荐升级这个版本，因为1.73版本已经开发出来了，我下一文就是发布1.73的，先发1.3是因为想保持版本的连续性。大家可以忽略。</p> <p>Google Code上的下载地址为：<a title="http&#58;//code.google.com/p/flora-ssh-d/downloads/list" href="http&#58;//code.google.com/p/flora-ssh-d/downloads/list" target="_blank">http&#58;//code.google.com/p/flora-ssh-d/downloads/list</a> （包含源代码）</p> <p>代码如下：</p> <blockquote> <p>(* Flora_ssh-D // Version 1.3 // Code by Leask Huang // www.leaskh.com // i@leaskh.com *)  <p>(* ======= Variable Declaration ======= *)<br />global timeTry<br />global DNSResponse<br />global isOLast  <p>(* ======= General Settings ======= *)<br />(* Custom these before you run this script *)  <p>set SSHServerName to &quot;*******&quot; -- Set ServerName, You must set this<br />set SSHUserName to &quot;*******&quot; -- Set UserName, You must set this<br />set SSHPasswd to &quot;*******&quot; -- Set Password, You must set this<br />set TwitterUsername to &quot;*******&quot; -- If you don't want to update Twitter status, leave it blank<br />set TwitterPassword to &quot;*******&quot; -- same as above<br />set TwitterText to &quot;@&quot; &amp; TwitterUsername &amp; &quot; is online now! // &quot; &amp; (current date) -- same as above<br />set DNSUsername to &quot;*******&quot;<br />set DNSPassword to &quot;*******&quot;<br />set appStList to &#123;&quot;Adium&quot;, &quot;CoverSutra&quot;, &quot;Google Notifier&quot;&#125; -- these aplications will launch while you are online (or leave it blank)<br />set appQuitList to &#123;&quot;CoverSutra&quot;, &quot;Google Notifier&quot;&#125; -- these aplications will quit while you are offline (or leave it blank)  <p>(* ======= Advanced Settings ======= *)<br />(* You don't need to change these normally *)  <p>(* ======= Main Script ======= *)<br />set isOLast to &quot;&quot;  <p>repeat<br />    delay 10000<br />end repeat<br />repeat<br />    if fnCheckNet() is true then<br />        if isOLast is not &quot;online&quot; then<br />            fnSSHCnt()<br />            fnAppStart()<br />            fnDNSUpdate()<br />            fnTwitter()<br />        end if<br />        set isOLast to &quot;online&quot;<br />        say &quot;All done!&quot;<br />    else<br />        if isOLast is not &quot;offline&quot; then<br />            fnAppQuit()<br />        end if<br />        set isOLast to &quot;offline&quot;<br />        say &quot;All done!&quot;<br />    end if<br />    -- delay 333<br />    delay 60<br />end repeat  <p>(* ======= Functions ======= *)<br />to fnCheckNet()<br />    try<br />        do shell script &quot;curl --connect-timeout 7 apple.com/favicon.ico&quot;<br />        if isOLast is not &quot;online&quot; then<br />            say &quot;Great! You are online.&quot;<br />        end if<br />        return true<br />    on error<br />        if isOLast is not &quot;offline&quot; then<br />            say &quot;Opps! You are offline.&quot;<br />        end if<br />        return false<br />    end try<br />end fnCheckNet  <p>to fnCheckSSHD()<br />    try<br />        do shell script &quot;curl --socks5 127.0.0.1&#58;7070 --connect-timeout 7 apple.com/favicon.ico&quot;<br />        say &quot;OK! SSH D has been successfully connected.&quot;<br />        return true<br />    on error<br />        if timeTry &gt; 0 then<br />            say &quot;Opps! SSH D connection failed.&quot;<br />        end if<br />        return false<br />    end try<br />end fnCheckSSHD  <p>to fnAppStart()<br />    if (count appStList) &gt; 0 then<br />        say &quot;Start Applications&quot;<br />        try<br />            repeat with intSti from 1 to (count appStList)<br />                tell application (item intSti of appStList)<br />                    activate<br />                end tell<br />            end repeat<br />        on error<br />            say &quot;Opps! Error.&quot;<br />        end try<br />    end if<br />end fnAppStart  <p>to fnAppQuit()<br />    if (count appQuitList) &gt; 0 then<br />        say &quot;Quit Applications&quot;<br />        try<br />            repeat with intSti from 1 to count appQuitList<br />                tell application (item intSti of appQuitList)<br />                    quit<br />                end tell<br />            end repeat<br />        on error<br />            say &quot;Opps! Error.&quot;<br />        end try<br />    end if<br />end fnAppQuit  <p>to fnSSHCnt()<br />    if (length of SSHServerName) &gt; 0 and (length of SSHUserName) &gt; 0 and (length of SSHPasswd) &gt; 0 then<br />        set timeTry to 0<br />        say &quot;Create SSH D connection&quot;<br />        repeat while fnCheckSSHD() is false<br />            if timeTry &gt; 0 then<br />                if (button returned of (display dialog &quot;Opps! ssh -D connection failed. Do you want to retry?&quot; &amp; return &amp; &quot;&quot; buttons &#123;&quot;Retry&quot;, &quot;Quit&quot;&#125;)) is &quot;Quit&quot; then<br />                    exit repeat<br />                end if<br />            end if<br />            fnShellSSH()<br />            set timeTry to timeTry + 1<br />        end repeat<br />    end if<br />end fnSSHCnt  <p>to fnShellSSH()<br />    try<br />        tell application &quot;Terminal&quot;<br />            quit<br />            delay 1<br />            activate<br />            delay 1<br />            do script &quot;rm ~/Downloads/.Flora_ssh-D.out&quot; in window 1<br />            do script &quot;killall ssh&quot; in window 1<br />            do script &quot;killall ssh-agent&quot; in window 1<br />            do script &quot;nohup ssh -D 7070 &quot; &amp; SSHUserName &amp; &quot;@&quot; &amp; SSHServerName &amp; &quot; &gt; Downloads/.Flora_ssh-D.out&quot; in window 1<br />        end tell<br />        say &quot;SSH D connection request and log in request have been sent. Waiting for response from remote server.&quot;<br />        tell application &quot;Terminal&quot;<br />            do script SSHPasswd in window 1<br />            delay 1<br />            quit<br />        end tell<br />    on error<br />        say &quot;Opps! Error.&quot;<br />    end try<br />end fnShellSSH  <p>to fnTwitter()<br />    if (length of TwitterUsername) &gt; 0 and (length of TwitterPassword) &gt; 0 and (length of TwitterText) &gt; 0 then<br />        say &quot;Update Twitter state&quot;<br />        try<br />            do shell script &quot;curl --user &quot; &amp; (quoted form of (TwitterUsername &amp; &quot;&#58;&quot; &amp; TwitterPassword)) &amp; &quot; --data-binary &quot; &amp; (quoted form of (&quot;status=&quot; &amp; TwitterText)) &amp; &quot; <a href="https&#58;//twitter.com/statuses/update.json&quot;">https&#58;//twitter.com/statuses/update.json&quot;</a><br />            say &quot;OK! Twitter state has been successfully updated.&quot;<br />        on error<br />            say &quot;Opps! Error.&quot;<br />        end try<br />    end if<br />end fnTwitter  <p>to fnDNSShell()<br />    try<br />        set DNSResponse to (do shell script &quot;curl <a href="https&#58;//&quot;">https&#58;//&quot;</a> &amp; DNSUsername &amp; &quot;&#58;&quot; &amp; DNSPassword &amp; &quot;@updates.dnsomatic.com/nic/update?&amp;wildcard=NOCHG&amp;mx=NOCHG&amp;backmx=NOCHG&quot;)<br />        if first word of DNSResponse is &quot;good&quot; then<br />            return true<br />        else<br />            return false<br />        end if<br />    on error<br />        return false<br />    end try<br />end fnDNSShell  <p>to fnDNSUpdate()<br />    if (length of DNSUsername) &gt; 0 and (length of DNSPassword) &gt; 0 then<br />        say &quot;Update dynamic IP&quot;<br />        if fnDNSShell() is true then<br />            say &quot;OK! Dynamic IP has been successfully updated to &quot; &amp; (second word of DNSResponse)<br />        else<br />            say &quot;Opps! Error.&quot;<br />        end if<br />    end if<br />end fnDNSUpdate</p></blockquote>  </div><h3>Comments</h3><div id="bp-15BAC1A170471DB_15074-comments" class="comments"></div></div></body></html>