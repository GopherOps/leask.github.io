<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" type="text/css" href="style.css" /><title>&#20851;&#20110;ssh -D&#32763;&#22681;&#20998;&#20139;&#30340;&#19968;&#20123;&#36951;&#34917;&#65288;&#38468;pac&#25991;&#20214;&#30340;&#25913;&#36827;&#25506;&#32034;&#65289;</title></head><body><h1 id="blog-Title"><a href="index.html">&#35;import &#34;Leask.h&#34;</a></h1><div id="bp"><h2 id="bp-15BAC1A170471DB_15093-Title">&#20851;&#20110;ssh -D&#32763;&#22681;&#20998;&#20139;&#30340;&#19968;&#20123;&#36951;&#34917;&#65288;&#38468;pac&#25991;&#20214;&#30340;&#25913;&#36827;&#25506;&#32034;&#65289;</h2><h5 id="bp-15BAC1A170471DB_15093-publish">11/8/2009 2&#58;19&#58;23 PM</h5><div id="bp-15BAC1A170471DB_15093-content" class="blogpost"><p>我曾在过去的文章中提到过，由于购买的商业ssh服务器大多数只允许一个用户在一个机器上登录，因此如果你家里有超过2个电脑需要翻墙，又或者你的iPhone或者iPod touch、PSP等和你的电脑位于同一个无线路由器下，你希望你的设备同样能分享主机的ssh -D连接。</p> <p>前文中我写到可以把代理服务器指向你已经创建ssh -D代理的主机，这样做在我的VM虚拟机里面是能够分享到宿主机Mac上的ssh -D连接。但是上个星期我购买了一款叫做Simplenote的软件，正当我想要同步Mac上的笔记到iPod touch上的时候发现同步失败。经过研究发现Simplenote同步需要连接Google appspot服务器，然而appspot在我所在的区域已经被“墙歼”了，于是我尝试在iPod touch上分享我Mac上的ssh -D连接，意外地失败了。测试手上的P1i通过wifi分享来自Mac上的ssh -D连接，同样失败。经过一番折腾，发现原来ssh -D默认是不响应来自远程主机发起的连接的，如果确实需要分享，你需要在ssh -D后面再加上一个-g的参数，如：</p> <blockquote> <p><em>ssh -D 7070 <strong><font color="#ff8040">-g</font></strong> </em><a href="mailto&#58;username@ssh.yourdomain.com"><em>username@ssh.yourdomain.com</em></a></p></blockquote> <p>用这个参数创建的连接能够顺利把ssh -D的代理分享出去，当然了，你可能还会遇到pac文件的烦恼，毕竟每个人所要求翻墙访问的站点都不同。下面我分享一下我的pac文件的写法：</p> <blockquote> <p><em>// Flora AntiGFW PAC<br />// Version 5.0<br />// by LeaskH.com<br />// i@leaskh.com </em> <p><em>function FindProxyForURL(url, host)<br />&#123;<br />    // AntiGFW<br />    var arrStrGFWSites = [<br />        &quot;appspot.com&quot;,<br />        &quot;honeonet.spaces.live.com&quot;,<br />        &quot;blogger.com&quot;,<br />        &quot;blogspot.com&quot;,<br />        &quot;w3schools.com&quot;,<br />        &quot;box.net&quot;,<br />        &quot;bit.ly&quot;,<br />        &quot;j.mp&quot;,<br />        &quot;vimeo.com&quot;,<br />        &quot;mediafire.com&quot;,<br />        &quot;wordpress.com&quot;,<br />        &quot;tistory.com&quot;,<br />        &quot;aol.com&quot;,<br />        &quot;aim.com&quot;,<br />        &quot;bebo.com&quot;,<br />        &quot;cnn.com&quot;,<br />        &quot;hellotxt.com&quot;,<br />        &quot;dougscripts.com&quot;,<br />        &quot;iphone-dev.org&quot;,<br />        &quot;dailymotion.com&quot;,<br />        &quot;yylyyl.co.cc&quot;,<br />        &quot;googlevideo.com&quot;,<br />        &quot;imageshack.us&quot;,<br />        &quot;cafepress.com&quot;,<br />        &quot;twitterfeed.com&quot;,<br />        &quot;hotspotshield.com&quot;,<br />        &quot;youtube.com&quot;,<br />        &quot;twitpic.com&quot;,<br />        &quot;mckaywei.com&quot;,<br />        &quot;mimima.com&quot;,<br />        &quot;no-ip.com&quot;,<br />        &quot;oikos.com.tw&quot;,<br />        &quot;////&quot;,<br />        &quot;ytimg.com&quot;,<br />        &quot;sesawe.net&quot;,<br />        &quot;freemorenews.com&quot;,<br />        &quot;theappleblog.com&quot;,<br />        &quot;chinagfw.org&quot;,<br />        &quot;chinadigitaltimes.net&quot;,<br />        &quot;dropbox.com&quot;,<br />        &quot;facebook.com&quot;,<br />        &quot;s.leaskh.com&quot;,<br />        &quot;sites.weborigin.co.nz&quot;,<br />        &quot;docs.weborigin.co.nz&quot;,<br />        &quot;calendar.weborigin.co.nz&quot;,<br />        &quot;google.com/search?*twitter&quot;,<br />        &quot;google.com/search?*@&quot;,<br />        &quot;google.com/search?*youtube&quot;,<br />        &quot;sites.leaskh.com&quot;,<br />        &quot;docs.leaskh.com&quot;,<br />        &quot;openvpn.net&quot;,<br />        &quot;simplenoteapp.com&quot;,<br />        &quot;code.leaskh.com&quot;,<br />        &quot;moderator.leaskh.com&quot;,<br />        &quot;calendar.leaskh.com&quot;,<br />        &quot;mail.weborigin.co.nz&quot;,<br />        &quot;mail.leaskh.com&quot;,<br />        &quot;yfrog.com&quot;,<br />        &quot;viewmorepics.myspace.com&quot;,<br />        &quot;messaging.myspace.com&quot;,<br />        &quot;</em><a href="http&#58;//*twitter.com&quot;"><em>http&#58;//*twitter.com&quot;</em></a><br /><em>    ];<br />    // Block unsafe sites<br />    var arrStrUNSSites = [&quot;74.55.154.140&quot;];<br />    var strActProxy = &quot;DIRECT&quot;;<br />    for(var iAS = 0; iAS &lt; arrStrGFWSites.length; iAS++)<br />    &#123;<br />        if(shExpMatch(url.toLowerCase(), &quot;*&quot; + arrStrGFWSites[iAS].toLowerCase() + &quot;*&quot;))<br />        &#123;<br />            switch (myIpAddress())<br />            &#123;</em></p> <p><em>                // When I using Virtual Machine<br />                case &quot;172.16.49.133&quot;&#58;   // My Virtual Machine’s IP</em><em><br />                    strActProxy = &quot;PROXY 127.0.0.1&#58;8118&quot;;   // My Privoxy Proxy on VM shared from Mac’s ssh -D<br />                break;<br /></em><em>                // When I using iPod touch<br />                case &quot;10.0.1.253&quot;&#58;   // My iPod touch’s IP<br />                    strActProxy = &quot;SOCKS 10.0.1.254&#58;7070&quot;;  // My iPod touch can visit my My by this IP<br />                break;<br /></em><em>                // When I using Mac<br />                default&#58;<br />                    strActProxy = &quot;SOCKS 127.0.0.1&#58;7070&quot;;  // My real ssh –D<br />                break;<br />            &#125;;<br />        &#125;;<br />    &#125;;<br />    for(var iAS = 0; iAS &lt; arrStrUNSSites.length; iAS++)<br />    &#123;<br />        if(shExpMatch(url.toLowerCase(), &quot;*&quot; + arrStrUNSSites[iAS].toLowerCase() + &quot;*&quot;))<br />        &#123;<br />            strActProxy = &quot;PROXY honeonet.spaces.live.com&quot;;  // Input a site which is already blocked by GFW<br />        &#125;;<br />    &#125;;<br />    return strActProxy;<br />&#125;;</em></p></blockquote> <p>以上就是我的pac脚本，应该说用pac分配代理服务器是非常便利和强大的。pac配合ssh -D简直就是“奔向自由”的两件神器。我的pac主要有如下特点： <ol> <li>通过单独一个pac文件，管理你所有设备的代理服务器，不再需要为每个不同的设备配置不同的pac文件了；</li> <li>把Twitter的适配URL写为：<a href="http&#58;//*twitter.com&quot;"><em>http&#58;//*twitter.com</em></a>，区别于网上的写法，因为Twitter是能够通过<em>https</em>访问的（改host），当我们通过https访问的时候，我们不需要通过代理，对于Tiwtter重度使用者，这样能够节省下很大程度的ssh流量，这样写只有使用普通http协议访问的时候才会通过代理；</li> <li>引入 <em>google.com/search?*twitter </em>的写法，就是当你的Google搜索关键字包含“Twitter”的时候，也通过代理访问Google，这个写法是很有用的，当然了根据实际用途，你要把“Twitter”改为你关心的，被和谐了的关键字哦，例如“六四”等等（不许联想）。</li> <li>引入 //// 的写法，就是加入一个网站你突然访问不到，你可以在URL地址后面加////，然后再尝试打开，那么这个地址就会通过代理访问了，那就不需要每次都改pac文件才知道站点是不是被墙了，十分便利哦；</li> <li>引入 google.com/search?*@ 的写法，由于Google出于私隐保护的需要，Email地址中的@符号是不会被Google索引的，所以@在搜索关键字中会被自动忽略，利用这一特性，我们在搜索一个敏感关键字的时候在关键字中插入一个@符号，那么就会自动通过代理访问Google了，由于Google会自动忽略@，所以并不会影响你的搜索结果，特别是在屏蔽比较多的图片搜索中，这个方法十分管用；</li> <li>出于安全考虑，有一些站点虽然没有被墙但是我们是不愿意访问的，例如带有病毒的站点或者钓鱼站点等，这些站点也能够利用pac文件来屏蔽，因此，我的pac脚本中带有两个数组，第一个是用来分辨是否被gfw墙的站点的，这个数组叫做arrStrGFWSites，然而我还引入了另一个数组arrStrUNSSites，用来过滤不安全的站点，你把自己认为不安全的站点写在里面就行了，脚本将把这个URL指向一个被墙的站点，达到过滤的目的。</li></ol> <p>本文的pac文件大家是不能直接用在自己的网络环境里的，写出来只是为了抛砖引玉，期待有喜欢折腾的高手写出更加智能的pac文件。</p> <p>服务于生活，这正是编程的意义所在。今天就写到这里。</p> <p>// 补充：如果你只需要在iPhone或者iPod touch上翻墙，那么由于iPhone OS基于Unix，是可以直接创建ssh链接的，只需要Cydia安装Openssh、Openssl和Mobile Terminal就可以了。基于Linux的设备也大同小异，例如Google的Android电话。</p>  </div><h3>Comments</h3><div id="bp-15BAC1A170471DB_15093-comments" class="comments"><div id="comment-15BAC1A170471DB_15165"><h5 id="comment-15BAC1A170471DB_15165">&#23792; - 1/27/2010 8&#58;08&#58;19 PM</h5>Leask.h 你好！想请教个问题<br /><br />我经常在几个不同的代理之间切换，有时 ssh 有时 tor 或别的，总得去修改 pac 文件。想加一个判断，当 ssh 可用时，使用 SOCKS 127.0.0.1&#58;7070，当 tor 可用时使用 PROXY 127.0.0.1&#58;8118 ，这个可以实现吗。对程序语言一窍不通，期待你的帮助！</div></div></div></body></html>